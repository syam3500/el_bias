RRF_norm[RRF_norm<0] <- 0.001 # avoiding negative numbers
hist(RRF_norm)
set.seed(123)
RRF_lnorm <- rlnorm(50, 0, 0.5)
RRF_lnorm[RRF_lnorm<0] <- 0.001 # avoiding negative numbers
hist(RRF_lnorm)
summary_table <- data.frame(
Method = character(),
FN_Rate = numeric(),
FP_Rate = numeric(),
FN_SD = numeric(),
FP_SD = numeric(),
precision = numeric(),
recall = numeric(),
F1 = numeric(),
f_beta = numeric()
)
set.seed(123)
N_sim <- 10000
N_extractables <- 80
total_FN <- 0
total_FP <- 0
total_TP <- 0
total_TN <- 0
for (i in 1:N_sim) {
## 1) Concentration around the AET
base_conc_sim <- runif(N_extractables, min = 0.5 * AET, max = 2 * AET)
## B) Normal Distribution of RRF around 1
simulated_RRF <- rnorm(N_extractables, 1, 0.2)
## I) No Correction
corrected_conc <- base_conc_sim * simulated_RRF
is_above_threshold <- base_conc_sim > AET
reported_above_threshold <- corrected_conc > AET
total_FN <- total_FN + sum(is_above_threshold & !reported_above_threshold, na.rm = TRUE)
total_FP <- total_FP + sum(!is_above_threshold & reported_above_threshold, na.rm = TRUE)
total_TP <- total_TP + sum(is_above_threshold & reported_above_threshold, na.rm = TRUE)
total_TN <- total_TN + sum(!is_above_threshold & !reported_above_threshold, na.rm = TRUE)
}
count_Above_AET <- total_TP + total_FN
count_Below_AET  <- total_TN + total_FP
FN_Rate_final <- total_FN / count_Above_AET
FP_Rate_final <- total_FP / count_Below_AET
recall <- total_TP / count_Above_AET
precision <- total_TP / (total_TP + total_FP)
F1 <- (2 * precision * recall / (precision + recall))
beta <- 5
f_beta <- (1 + beta^2) * (precision * recall) / ((beta^2 * precision) + recall)
SD_FN <- sqrt(FN_Rate_final * (1 - FN_Rate_final) / count_Above_AET)
SD_FP <- sqrt(FP_Rate_final * (1 - FP_Rate_final) / count_Below_AET)
summary_table <- rbind(summary_table, data.frame(
Method = "No Correction",
FN_Rate = FN_Rate_final,
FP_Rate = FP_Rate_final,
FN_SD = SD_FN,
FP_SD = SD_FP,
precision = precision,
recall = recall,
F1 = F1,
f_betal = f_beta
))
summary_table
hist(base_conc_sim,
main = "Histogram of Base concentration around the AET",
xlab = "Concentration",
col = "skyblue")
hist(simulated_RRF,
main = "Histogram of RRFs (non-parametric bootstrap of GC/MS dataset 5µg/mL) from FDA Clap list",
xlab = "Concentration",
col = "grey")
rsd <- function(x) {
return(sd(x, na.rm = TRUE) / mean(x, na.rm = TRUE))
}
set.seed(123)
N_sim <- 10000
UF_RSD <- 1/(1 - rsd(rnorm(N_extractables, 1, 0.2)) # formula from ISO 10993-18
UF_list <- c(
Sys.setenv(RETICULATE_PYTHON = "C:/Users/misak/anaconda3/python.exe")
#install.packages("tabulapdf")
# Load required packages
library(tidyverse)
library(dplyr)
library(purrr)
library(lubridate)
library(ggplot2)
library(here)
library(parallel)
library(pdftools)
library(stringr)
library(rJava)
library(tabulapdf) # for data tables extraction
library(readxl)
library(reticulate)
#py_install(c("pandas", "joblib", "scikit-learn"))
gcms_clap <- read_excel(
path = "processed_data/GCMS.xlsx",
sheet = "GC-MS")
gcms_clap_clean <- gcms_clap %>%
na.omit()
gcms_clap_clean
gcms_clap_clean$"5 µg/mL" <- as.numeric(gcms_clap_clean$"5 µg/mL")
gcms_clap_clean$"10 µg/mL" <- as.numeric(gcms_clap_clean$"10 µg/mL")
gcms_clap_clean$"20 µg/mL" <- as.numeric(gcms_clap_clean$"20 µg/mL")
hist(gcms_clap_clean$"5 µg/mL",
main = "Histogram of RRFs for GC/MS with a 5 µg/mL surrogate Concentration",
xlab = "RRF",
col = "skyblue")
hist(gcms_clap_clean$"10 µg/mL",
main = "Histogram of RRFs for GC/MS with a 10 µg/mL surrogate Concentration",
xlab = "RRF",
col = "orange")
hist(gcms_clap_clean$"20 µg/mL",
main = "Histogram of RRFs for GC/MS with a 20 µg/mL surrogate Concentration",
xlab = "RRF",
col = "red")
lcmspos_clap <- read_excel(
path = "processed_data/LCMS.xlsx",
sheet = "LCMSPOS")
lcmspos_clap_clean <- lcmspos_clap %>%
na.omit()
hist(lcmspos_clap_clean$"5 µg/mL",
main = "Histogram of RRFs for GC/MS with a 5 µg/mL surrogate Concentration",
xlab = "RRF",
col = "skyblue")
hist(lcmspos_clap_clean$"10 µg/mL",
main = "Histogram of RRFs for GC/MS with a 10 µg/mL surrogate Concentration",
xlab = "RRF",
col = "orange")
hist(lcmspos_clap_clean$"20 µg/mL",
main = "Histogram of RRFs for GC/MS with a 20 µg/mL surrogate Concentration",
xlab = "RRF",
col = "red")
lcmsneg_clap <- read_excel(
path = "processed_data/LCMS.xlsx",
sheet = "LCMSNEG")
lcmsneg_clap_clean <- lcmsneg_clap %>%
na.omit()
lcmsneg_clap_clean
hist(lcmsneg_clap_clean$"5 µg/mL",
main = "Histogram of RRFs for GC/MS with a 5 µg/mL surrogate Concentration",
xlab = "RRF",
col = "skyblue")
hist(lcmsneg_clap_clean$"10 µg/mL",
main = "Histogram of RRFs for GC/MS with a 10 µg/mL surrogate Concentration",
xlab = "RRF",
col = "orange")
hist(lcmsneg_clap_clean$"20 µg/mL",
main = "Histogram of RRFs for GC/MS with a 20 µg/mL surrogate Concentration",
xlab = "RRF",
col = "red")
AET <- 5
set.seed(123)
base_concentrations1 <- runif(100, min = 0.5 * AET, max = 2 * AET)
hist(base_concentrations1)
set.seed(123)
base_concentrations2 <- rlnorm(100, meanlog = -1.15, sdlog = 1.91)
hist(base_concentrations2)
set.seed(123)
Z <- runif(70, min = 0.001, max = 1)
Y <- runif(20, min = 1, max = 10)
K <- runif(10, min = 10, max = 100)
custom <- c(Z, Y, K)
custom_sampled <- sample(custom, size = 100, replace = FALSE)
hist(custom_sampled)
set.seed(123)
RRF_norm <- rnorm(50, 1, 0.2)
RRF_norm[RRF_norm<0] <- 0.001 # avoiding negative numbers
hist(RRF_norm)
set.seed(123)
RRF_lnorm <- rlnorm(50, 0, 0.5)
RRF_lnorm[RRF_lnorm<0] <- 0.001 # avoiding negative numbers
hist(RRF_lnorm)
summary_table <- data.frame(
Method = character(),
FN_Rate = numeric(),
FP_Rate = numeric(),
FN_SD = numeric(),
FP_SD = numeric(),
precision = numeric(),
recall = numeric(),
F1 = numeric(),
f_beta = numeric()
)
set.seed(123)
N_sim <- 10000
N_extractables <- 80
total_FN <- 0
total_FP <- 0
total_TP <- 0
total_TN <- 0
for (i in 1:N_sim) {
## 1) Concentration around the AET
base_conc_sim <- runif(N_extractables, min = 0.5 * AET, max = 2 * AET)
## B) Normal Distribution of RRF around 1
simulated_RRF <- rnorm(N_extractables, 1, 0.2)
## I) No Correction
corrected_conc <- base_conc_sim * simulated_RRF
is_above_threshold <- base_conc_sim > AET
reported_above_threshold <- corrected_conc > AET
total_FN <- total_FN + sum(is_above_threshold & !reported_above_threshold, na.rm = TRUE)
total_FP <- total_FP + sum(!is_above_threshold & reported_above_threshold, na.rm = TRUE)
total_TP <- total_TP + sum(is_above_threshold & reported_above_threshold, na.rm = TRUE)
total_TN <- total_TN + sum(!is_above_threshold & !reported_above_threshold, na.rm = TRUE)
}
count_Above_AET <- total_TP + total_FN
count_Below_AET  <- total_TN + total_FP
FN_Rate_final <- total_FN / count_Above_AET
FP_Rate_final <- total_FP / count_Below_AET
recall <- total_TP / count_Above_AET
precision <- total_TP / (total_TP + total_FP)
F1 <- (2 * precision * recall / (precision + recall))
beta <- 5
f_beta <- (1 + beta^2) * (precision * recall) / ((beta^2 * precision) + recall)
SD_FN <- sqrt(FN_Rate_final * (1 - FN_Rate_final) / count_Above_AET)
SD_FP <- sqrt(FP_Rate_final * (1 - FP_Rate_final) / count_Below_AET)
summary_table <- rbind(summary_table, data.frame(
Method = "No Correction",
FN_Rate = FN_Rate_final,
FP_Rate = FP_Rate_final,
FN_SD = SD_FN,
FP_SD = SD_FP,
precision = precision,
recall = recall,
F1 = F1,
f_betal = f_beta
))
summary_table
hist(base_conc_sim,
main = "Histogram of Base concentration around the AET",
xlab = "Concentration",
col = "skyblue")
hist(simulated_RRF,
main = "Histogram of RRFs (non-parametric bootstrap of GC/MS dataset 5µg/mL) from FDA Clap list",
xlab = "Concentration",
col = "grey")
rsd <- function(x) {
return(sd(x, na.rm = TRUE) / mean(x, na.rm = TRUE))
}
set.seed(123)
N_sim <- 10000
UF_RSD <- 1/(1 - rsd(rnorm(N_extractables, 1, 0.2))) # formula from ISO 10993-18
UF_list <- c(
"UF (2)"   = 2,
"UF (4)"   = 4,
"UF (5)"   = 5,
"UF (10)"  = 10,
"UF (RSD)" = UF_RSD
)
N_extractables <- 80
for (m_name in names(UF_list)) {
uf_val <- UF_list[[m_name]]
total_FN <- 0
total_FP <- 0
total_TP <- 0
total_TN <- 0
for (i in 1:N_sim) {
## 1) Concentration around the AET
base_conc_sim <- runif(N_extractables, min = 0.5 * AET, max = 2 * AET)
## B) Normal Distribution of RRF around 1
simulated_RRF <- rnorm(N_extractables, 1, 0.2)
## II) UF corrections
exp_conc <- (base_conc_sim * simulated_RRF)
corrected_conc <- exp_conc * uf_val
is_above_threshold <- base_conc_sim > AET
reported_above_threshold <- corrected_conc > AET
total_FN <- total_FN + sum(is_above_threshold & !reported_above_threshold, na.rm = TRUE)
total_FP <- total_FP + sum(!is_above_threshold & reported_above_threshold, na.rm = TRUE)
total_TP <- total_TP + sum(is_above_threshold & reported_above_threshold, na.rm = TRUE)
total_TN <- total_TN + sum(!is_above_threshold & !reported_above_threshold, na.rm = TRUE)
}
count_Above_AET <- total_TP + total_FN
count_Below_AET  <- total_TN + total_FP
FN_Rate_final <- total_FN / count_Above_AET
FP_Rate_final <- total_FP / count_Below_AET
recall <- total_TP / count_Above_AET
precision <- total_TP / (total_TP + total_FP)
F1 <- (2 * precision * recall / (precision + recall))
beta <- 5
f_beta <- (1 + beta^2) * (precision * recall) / ((beta^2 * precision) + recall)
SD_FN <- sqrt(FN_Rate_final * (1 - FN_Rate_final) / count_Above_AET)
SD_FP <- sqrt(FP_Rate_final * (1 - FP_Rate_final) / count_Below_AET)
summary_table <- rbind(summary_table, data.frame(
Method = m_name,
FN_Rate = FN_Rate_final,
FP_Rate = FP_Rate_final,
FN_SD = SD_FN,
FP_SD = SD_FP,
precision = precision,
recall = recall,
F1 = F1,
f_betal = f_beta
))
}
UF_RSD
summary_table
percentile <- function(x) {
return(quantile(x, .16))
}
set.seed(123)
N_sim <- 10000
N_extractables <- 80
total_FN <- 0
total_FP <- 0
total_TP <- 0
total_TN <- 0
meanGCMS <- mean(rnorm(N_extractables, 1, 0.2))
percentileGCMS <- percentile(rnorm(N_extractables, 1, 0.2))
for (i in 1:N_sim) {
## 1) Concentration around the AET
base_conc_sim <- runif(N_extractables, min = 0.5 * AET, max = 2 * AET)
## B) Normal Distribution of RRF around 1
simulated_RRF <- rnorm(N_extractables, 1, 0.2)
exp_conc <- (base_conc_sim * simulated_RRF)
## III) 16th percentile Correction
corrected_conc <- exp_conc * (meanGCMS / percentileGCMS)
is_above_threshold <- base_conc_sim > AET
reported_above_threshold <- corrected_conc > AET
total_FN <- total_FN + sum(is_above_threshold & !reported_above_threshold, na.rm = TRUE)
total_FP <- total_FP + sum(!is_above_threshold & reported_above_threshold, na.rm = TRUE)
total_TP <- total_TP + sum(is_above_threshold & reported_above_threshold, na.rm = TRUE)
total_TN <- total_TN + sum(!is_above_threshold & !reported_above_threshold, na.rm = TRUE)
}
count_Above_AET <- total_TP + total_FN
count_Below_AET  <- total_TN + total_FP
FN_Rate_final <- total_FN / count_Above_AET
FP_Rate_final <- total_FP / count_Below_AET
recall <- total_TP / count_Above_AET
precision <- total_TP / (total_TP + total_FP)
F1 <- (2 * precision * recall / (precision + recall))
beta <- 5
f_beta <- (1 + beta^2) * (precision * recall) / ((beta^2 * precision) + recall)
SD_FN <- sqrt(FN_Rate_final * (1 - FN_Rate_final) / count_Above_AET)
SD_FP <- sqrt(FP_Rate_final * (1 - FP_Rate_final) / count_Below_AET)
summary_table <- rbind(summary_table, data.frame(
Method = "Percentile (16th)",
FN_Rate = FN_Rate_final,
FP_Rate = FP_Rate_final,
FN_SD = SD_FN,
FP_SD = SD_FP,
precision = precision,
recall = recall,
F1 = F1,
f_betal = f_beta
))
## RSD is calculated only for RRFs between 0.05 and 1
## 'Compounds with RRF lower than 0.05 are excluded from UF calculation (20 times lower than the internal standard).page 8
## Therefore, as a criterion for RRF selection, only compounds with an RRF less than 1 are actually considered for UF calculation. page 8
rsd <- function(x) {
x_use = x[x<=1&x>0.05]
return(sd(x_use, na.rm = TRUE) / mean(x_use, na.rm = TRUE))
}
## Simulation starts
set.seed(123)
N_sim <- 10000
N_extractables <- 80
total_FN <- 0
total_FP <- 0
total_TP <- 0
total_TN <- 0
# remove 0 values
RRF_GCMS_superior0 <- gcms_clap_clean$"5 µg/mL"
RRF_GCMS_superior0 <- RRF_GCMS_superior0[RRF_GCMS_superior0 > 0]
# Apply Part 18 formula for database
UF <- 1/(1-rsd(rnorm(N_extractables, 1, 0.2)))
# Start simulation
for (i in 1:N_sim) {
## 1) Concentration around the AET
base_conc_sim <- runif(N_extractables, min = 0.5 * AET, max = 2 * AET)
## B) Normal Distribution of RRF around 1
simulated_RRF <- rnorm(N_extractables, 1, 0.2)
## IV) RRflow condition
exp_conc <- base_conc_sim * simulated_RRF   # experimental concentration : True concentration with the actual RRF
corrected_conc <- exp_conc * UF             # corrected concentration: Exp * UF (conservative method)
condition <- (simulated_RRF < 0.5) | (simulated_RRF > 2) # RRFlow conditions rescaling factor should be focused only to those compounds which exhibits RRF< 0.5 and RRF>2
corrected_conc[condition] <- exp_conc[condition] / simulated_RRF[condition] # average value of the RRF RRFlow application in extractables amount rescaling ( The average RRF determined by the RRFlow will be used to re-calculate the amount of the corresponding compound detected in the extractables study , will assume that it is in the linearity range)
is_above_threshold <- base_conc_sim > AET
reported_above_threshold <- corrected_conc > AET
total_FN <- total_FN + sum(is_above_threshold & !reported_above_threshold, na.rm = TRUE)
total_FP <- total_FP + sum(!is_above_threshold & reported_above_threshold, na.rm = TRUE)
total_TP <- total_TP + sum(is_above_threshold & reported_above_threshold, na.rm = TRUE)
total_TN <- total_TN + sum(!is_above_threshold & !reported_above_threshold, na.rm = TRUE)
}
count_Above_AET <- total_TP + total_FN
count_Below_AET  <- total_TN + total_FP
FN_Rate_final <- total_FN / count_Above_AET
FP_Rate_final <- total_FP / count_Below_AET
recall <- total_TP / count_Above_AET
precision <- total_TP / (total_TP + total_FP)
F1 <- (2 * precision * recall / (precision + recall))
beta <- 5
f_beta <- (1 + beta^2) * (precision * recall) / ((beta^2 * precision) + recall)
SD_FN <- sqrt(FN_Rate_final * (1 - FN_Rate_final) / count_Above_AET)
SD_FP <- sqrt(FP_Rate_final * (1 - FP_Rate_final) / count_Below_AET)
summary_table <- rbind(summary_table, data.frame(
Method = "RRFlow",
FN_Rate = FN_Rate_final,
FP_Rate = FP_Rate_final,
FN_SD = SD_FN,
FP_SD = SD_FP,
precision = precision,
recall = recall,
F1 = F1,
f_betal = f_beta
))
UF
summary_table
set.seed(123)
N_sim <- 10000
N_extractables <- 80
total_FN <- 0
total_FP <- 0
total_TP <- 0
total_TN <- 0
conservative_RRF_estimate <- quantile(rnorm(N_extractables, 1, 0.2), 0.10)
for (i in 1:N_sim) {
## 1) Concentration around the AET
base_conc_sim <- runif(N_extractables, min = 0.5 * AET, max = 2 * AET)
## B) Normal Distribution of RRF around 1
simulated_RRF <- rnorm(N_extractables, 1, 0.2)
## V RRF < 1
exp_conc <- base_conc_sim * simulated_RRF   # experimental concentration : True concentration with the actual RRF
corrected_conc <- exp_conc / conservative_RRF_estimate
is_above_threshold <- base_conc_sim > AET
reported_above_threshold <- corrected_conc > AET
total_FN <- total_FN + sum(is_above_threshold & !reported_above_threshold, na.rm = TRUE)
total_FP <- total_FP + sum(!is_above_threshold & reported_above_threshold, na.rm = TRUE)
total_TP <- total_TP + sum(is_above_threshold & reported_above_threshold, na.rm = TRUE)
total_TN <- total_TN + sum(!is_above_threshold & !reported_above_threshold, na.rm = TRUE)
}
count_Above_AET <- total_TP + total_FN
count_Below_AET  <- total_TN + total_FP
FN_Rate_final <- total_FN / count_Above_AET
FP_Rate_final <- total_FP / count_Below_AET
recall <- total_TP / count_Above_AET
precision <- total_TP / (total_TP + total_FP)
F1 <- (2 * precision * recall / (precision + recall))
beta <- 5
f_beta <- (1 + beta^2) * (precision * recall) / ((beta^2 * precision) + recall)
SD_FN <- sqrt(FN_Rate_final * (1 - FN_Rate_final) / count_Above_AET)
SD_FP <- sqrt(FP_Rate_final * (1 - FP_Rate_final) / count_Below_AET)
summary_table <- rbind(summary_table, data.frame(
Method = "Percentile 10th",
FN_Rate = FN_Rate_final,
FP_Rate = FP_Rate_final,
FN_SD = SD_FN,
FP_SD = SD_FP,
precision = precision,
recall = recall,
F1 = F1,
f_betal = f_beta
))
summary_table
set.seed(123)
target_recall <- 0.95
found <- FALSE
optimal_percentile <- NA
N_sim <- 10000
N_extractables <- 80
for (test_percentile in seq(0.50, 0.01, by = -0.01)) {
conservative_RRF_estimate <- quantile(rnorm(N_extractables, 1, 0.2), test_percentile, na.rm=TRUE)
total_FN <- 0
total_FP <- 0
total_TP <- 0
total_TN <- 0
for (i in 1:N_sim) {
base_conc_sim <- runif(N_extractables, min = 0.5 * AET, max = 2 * AET)
simulated_RRF <- rnorm(N_extractables, 1, 0.2)
exp_conc <- base_conc_sim * simulated_RRF
corrected_conc <- exp_conc / conservative_RRF_estimate
is_above_threshold <- base_conc_sim > AET
reported_above_threshold <- corrected_conc > AET
total_FN <- total_FN + sum(is_above_threshold & !reported_above_threshold, na.rm = TRUE)
total_FP <- total_FP + sum(!is_above_threshold & reported_above_threshold, na.rm = TRUE)
total_TP <- total_TP + sum(is_above_threshold & reported_above_threshold, na.rm = TRUE)
total_TN <- total_TN + sum(!is_above_threshold & !reported_above_threshold, na.rm = TRUE)
}
current_recall <- total_TP / (total_TP + total_FN)
print(paste("Percentile:", test_percentile, "-> Recall:", round(current_recall, 4)))
if(current_recall >= target_recall) {
optimal_percentile <- test_percentile
found <- TRUE
break
}
}
if(found) {
print(paste("Optimal Percentile for 95% Recall:", optimal_percentile))
count_Above_AET <- total_TP + total_FN
count_Below_AET  <- total_TN + total_FP
FN_Rate_final <- total_FN / count_Above_AET
FP_Rate_final <- total_FP / count_Below_AET
recall <- total_TP / count_Above_AET
precision <- total_TP / (total_TP + total_FP)
F1 <- (2 * precision * recall / (precision + recall))
beta <- 5
f_beta <- (1 + beta^2) * (precision * recall) / ((beta^2 * precision) + recall)
SD_FN <- sqrt(FN_Rate_final * (1 - FN_Rate_final) / count_Above_AET)
SD_FP <- sqrt(FP_Rate_final * (1 - FP_Rate_final) / count_Below_AET)
summary_table <- rbind(summary_table, data.frame(
Method = paste0("Optimized_P"),
FN_Rate = FN_Rate_final,
FP_Rate = FP_Rate_final,
FN_SD = SD_FN,
FP_SD = SD_FP,
precision = precision,
recall = recall,
F1 = F1,
f_betal = f_beta
))
} else {
print("1st percentile was not conservative enough to reach 95% recall.")
}
summary_table
reticulate::repl_python()
